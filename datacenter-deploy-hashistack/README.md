# Currently Under Development - 07/2021

## Overview

Deploy, secure, and scale a sample microservice application with the Hashistack (Terraform, Consul, and Vault).

![](images/hashistack-cloud-operating-model.png)

## Prerequisites

- Docker
- Terraform v0.14+

## Deployment procedure

1. Clone [learn-consul-docker](https://github.com/hashicorp/learn-consul-docker) repository.
2. Navigate to this directory.
3. Edit the terraform `pwd` variable in `docker.tf` to the absolute path of your working directory
4. `terraform init`
5. `terraform apply`

## Testing procedure

1. Navigate to [http://localhost:9090/ui/](http://localhost:9090/ui/).
2. Notice the architecture of the application stack. 
3. Navigate to [http://localhost:8500/ui/dc1/services](http://localhost:8500/ui/dc1/services)
4. Notice the services and nodes being monitored by Consul.
5. Install Consul on each application container:
   1.  `docker exec -d web apk add consul`
   2.  `docker exec -d api apk add consul`
6.  Start the Consul agent manually on each application container:
    1.  `docker exec -d web consul agent --config-dir=/var/consul/config/`
    2.  `docker exec -d api consul agent --config-dir=/var/consul/config/`
7.  Navigate to [http://localhost:8500/ui/dc1/services](http://localhost:8500/ui/dc1/services)
8.  Notice the services, health checks, and nodes now being monitored by Consul.
9.  Append the contents of `additional-servers.txt` to your `docker.tf`:
    1.  `cat additional-servers.txt >> docker.tf`
10. `terraform apply`
11. Install Consul on each newly-created application container:
    1.  `docker exec -d web2 apk add consul`
12. Start the Consul agent manually on the newly-created application container:
    1.  `docker exec -d web2 consul agent --config-dir=/var/consul/config/`
13.  Navigate to [http://localhost:8500/ui/dc1/services/web/instances](http://localhost:8500/ui/dc1/services/web/instances)
14. Notice the additional instances of the `web` service now being monitored by Consul.
15. ---VAULT CONTENT  development in progress) ---
16. Check the container logs to get the root token generated by Vault
    1.  `docker logs vault`
17. Navigate to [http://localhost:8200/ui/](http://localhost:8200/ui/).
18. Login using the root token.
19. core vault content
20. consul + vault content (use-cases)
21. consul + terraform content (use-cases)

## Concepts Covered

1. Terraform
   1. Infrastructure as Code
   2. Scaling
2. Consul
   1. Service Discovery
   2. Health Checking
3. Vault
   1. Secret Management
   2. Automatic Gossip Key Rotation

## Additional information

- [https://www.hashicorp.com/cloud-operating-model](https://www.hashicorp.com/cloud-operating-model)
- [https://learn.hashicorp.com/collections/consul/docker](https://learn.hashicorp.com/collections/consul/docker)
- [https://learn.hashicorp.com/tutorials/consul/vault-kv-consul-secure-gossip](https://learn.hashicorp.com/tutorials/consul/vault-kv-consul-secure-gossip)
- [https://learn.hashicorp.com/tutorials/vault/codify-mgmt-oss](https://learn.hashicorp.com/tutorials/vault/codify-mgmt-oss)
- [https://learn.hashicorp.com/tutorials/consul/vault-consul-secrets](https://learn.hashicorp.com/tutorials/consul/vault-consul-secrets)

## Application reference

This demo consists of two example services, Web (HTTP) and API (gRPC).

```
web (HTTP)  --
                api (gRPC)
```

## Gratitude

- [Nic Jackson @ Hashicorp](https://github.com/nicholasjackson)
- [Rosemary Wang @ Hashicorp](https://github.com/joatmon08)